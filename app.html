<!DOCTYPE html>
<html>

<head>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.10/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.10/angular-resource.min.js"></script>
	<script>
	var app = angular.module('dashboard', ['ngResource']);

	app.factory('Servers', function($resource) {
	  return $resource('http://localhost:10001/servers');
	});

	app.factory('Log', function($resource) {
		return $resource('http://localhost:10001/log');
	});

	app.factory('Settings', function($resource) {
		return $resource(
			'http://localhost:10001/settings',
			'',
			{ 'query':  {method:'GET', isArray:false} }
		);
	});

	app.factory('Master', function($resource) {
		return $resource(
			'http://localhost:10001/master',
			'',
			{ 'query':  {method:'GET', isArray:false} }
		);
	});


	app.controller('DashboardController', ['$scope', '$interval', '$http', 'Servers', 'Log', 'Settings', 'Master', function ($scope, $interval, $http, Servers, Log, Settings, Master) {
		$interval(function(){
	  Servers.query({}, function(data) {
	    $scope.servers = data;
	  });
		Log.query({}, function(data) {
			$scope.log = data;
		});
		Settings.query({}, function(data) {
	    $scope.settings = data;
	  });
		Master.query({}, function(data) {
			$scope.master = data;
		});
	}, 1000);
	$scope.switch = function(fail) {
		if (fail == false) {
			var r = confirm("Confirm switchover");
			if (r == true) {
				var response = $http.get('http://localhost:10001/switchover');
				response.success(function(data, status, headers, config) {
						console.log("Ok.");
				});
				response.error(function(data, status, headers, config) {
						console.log("Error.");
				});
			}
		}
		else {
			var r = confirm("Confirm failover");
			if (r == true) {
				var response = $http.get('http://localhost:10001/failover');
				response.success(function(data, status, headers, config) {
						console.log("Ok.");
				});
				response.error(function(data, status, headers, config) {
						console.log("Error.");
				});
			}
		}
};
$scope.inttoggle = function() {
	var r = confirm("Confirm Mode Change");
	if (r == true) {
		var response = $http.get('http://localhost:10001/interactive');
		response.success(function(data, status, headers, config) {

				console.log("Ok.");

		});

		response.error(function(data, status, headers, config) {
				console.log("Error.");
		});
}
};
$scope.gtidstring = function(arr) {
	var output = [];
	for (i = 0; i < arr.length; i++) {
		var gtid = "";
		gtid = arr[i]["DomainID"] + '-' + arr[i]["ServerID"] + '-' + arr[i]["SeqNo"];
		output.push(gtid)
	}
	return output.join(",");
};
}]);

	</script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
	<style>
td {
    white-space: nowrap;
}
</style>
</head>

<body ng-app="dashboard">
  <div ng-controller="DashboardController" class="col-lg-12">
		<h2>Replication Manager Status</h2>
		<p>Current Mode <span ng-if="settings.interactive=='true'" class="label label-primary">on-call</span><span ng-if="settings.interactive=='false'" class="label label-warning">on-leave</span></p>
		<table ng-if="servers" class="table">
			<tr>
				<th>Host</th>
				<th>Port</th>
				<th>Status</th>
				<th>Using GTID</th>
				<th>Current GTID</th>
				<th>Slave GTID Pos</th>
				<th>Slave IO Thread</th>
				<th>Slave SQL Thread</th>
				<th>Delay</th>
				<th>Read Only</th>
			</tr>
			<tr ng-repeat="server in servers" ng-class="{'active':server.State=='Master','danger': (server.IOThread=='No' && server.State=='Slave')}">
				<td>{{server.Host}}</td>
				<td>{{server.Port}}</td>
				<td>{{server.State}}</td>
				<td>{{server.UsingGtid}}</td>
				<td>{{gtidstring(server.CurrentGtid)}}</td>
				<td>{{gtidstring(server.SlaveGtid)}}</td>
				<td>{{server.IOThread}}</td>
				<td>{{server.SQLThread}}</td>
				<td>{{server.Delay.Int64}}</td>
				<td>{{server.ReadOnly}}</td>
			</tr>
		</table>
		<p>
		<button ng-if="master.State !='Failed'" type="button" class="btn btn-primary" ng-click="switch(false)">Switchover</button>
		<button ng-if="master.State =='Failed'" type="button" class="btn btn-danger" ng-click="switch(true)">Failover</button>
		<button type="button" class="btn btn-primary" ng-click="inttoggle()">Mode Change</button>
	</p>
	<pre>
<span ng-repeat="logline in log track by $index">{{ logline }}
</span>
	</pre>
	</div>
</body>

</html>
